{% extends 'base.html' %}
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <script src="{% static 'js/index.js' %}"></script>
</head>

{% block content %}
<body>    
    <div id="wrapper">
        <div class="inner">
            <section id="main" style="position:relative">
                {% if request.user.is_authenticated %}
                    <div style="position:flex; display:block">
                        <a href="{% url 'services:main' %}"><img src="{% static 'images/recommend_logo.png' %}" style="position:relative; top:0px; left:40px; z-index:1; margin-bottom:20px; margin-top:20px" width="350px" height="70px" ></a>
                    </div>
                    <a id="logout-button"  style="position:absolute; top:40px; right:330px; width:100px; height:20px; font-size:18px" href="{% url 'accounts:mypage' %}" method="POST">ğŸ MyPage</a>
                    <a id="feedback-button"  style="position:absolute; top:40px; right:160px; width:125px; height:20px; font-size:17px" href="https://forms.gle/6sMBUGZFz2sQESaN7">ğŸ“®í”¼ë“œë°± ë‚¨ê¸°ê¸°</a>
                    <a id="logout-button"  style="position:absolute; top:40px; right:50px; width:65px; height:20px; font-size:20px" href="{% url 'accounts:logout' %}" method="POST">logout</a>
                {% endif %}
                <div class="mainWrap">              
                    <div class="submitWrap part">
                        {% csrf_token %}
                        <h3>ê¸°ì—… ë° ì§ë¬´ ë¶„ë¥˜ ì„ íƒ</h3>
                        <div class="filter">
                            <div class="cbList">
                                <h4 class="filter-category">ê¸°ì—…ê²€ìƒ‰</h4>
                                <div class="cb">
                                    <input placeholder="ê¸°ì—…ì„ ê²€ìƒ‰í•˜ì„¸ìš”" list="company-list" name="company-input" id="company-input">
                                    <datalist id="company-list">
                                    {% for company in companies %}
                                        <option value={{ company.company }} label={{ company.company }}>
                                    {% endfor %}
                                    </datalist>
                                </div>
                            </div>
                            <div class="cbList">
                                <h4 class="filter-category">ì§ë¬´ ëŒ€ë¶„ë¥˜</h4>
                                <br/>
                                {% for job in job_list %}
                                    <div class="cb">
                                        <input type="checkbox" name="job_main" id={{ job.id }} value={{ job.job_small }} onClick="checkOnlyOne(this); job_check(this,{{ job.job_small }},{{ job.job_small_id }});">
                                        <label for={{ job.id }}>
                                            <span class="cbText">{{ job.job_large }}</span>
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="cbList">
                                <h4 class="filter-category">ì§ë¬´ ì†Œë¶„ë¥˜</h4>
                                <br/>
                                <div id = 'job_result'></div>
                            </div>
                        </div>
                        <div style="display:flex">
                          <h3>ë‚´ ìì†Œì„œ ì…ë ¥í•˜ê¸°</h3>
                          <div class="help-tip" id="help-main">
                            <p>
                                RecommendUëŠ”
                            <br>ì§ë¬´, íšŒì‚¬, ì§ˆë¬¸ ê·¸ë¦¬ê³  ì‘ì„±ìì˜ ë‹µë³€ì„ ê³ ë ¤í•˜ì—¬ 
                            <br>ì‚¬ìš©ìì™€ ìœ ì‚¬í•œ í•©ê²© ìê¸°ì†Œê°œì„œë¥¼ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤.
                            <br> 
                            <br>â—Tipâ—
                            <br>í•˜ë‚˜, ìì†Œì„œ ë¬¸í•­ì„ ì§ì ‘ ì…ë ¥í•  ë•Œ ì›í•˜ëŠ” ê²°ê³¼ê°€ ë‚˜ì˜¤ì§€ ì•ŠëŠ”ë‹¤ë©´, ì§ˆë¬¸ì„ ì¡°ê¸ˆ ë°”ê¿”ë³´ì„¸ìš”. 
                            <br>ë‘˜, ì§ì ‘ ì…ë ¥í•œ ë‹µë³€ì´ ì—†ê±°ë‚˜ ë„ˆë¬´ ì§§ë‹¤ë©´, ë‹µë³€ì€ ì¶”ì²œ ê²°ê³¼ì— ë°˜ì˜ë˜ì§€ ì•Šì•„ìš”.
                            <br>ì…‹, ë§Œì¼ ì§ì ‘ ì…ë ¥ì´ ë§‰ë§‰í•˜ë‹¤ë©´ ë¯¸ì™„ì„± ìƒ˜í”Œì„ ì‚¬ìš©í•´ë³´ì„¸ìš”.
                            <br>ë§ˆì§€ë§‰ìœ¼ë¡œ, í•©ê²©ìì†Œì„œëŠ” ì°¸ê³ ìš©ì¼ë¿! ë˜‘ê°™ì´ ë”°ë¼ì“°ì‹œë©´ ì•ˆë˜ëŠ”ê±° ì•„ì‹œì£ ? ğŸ˜‰
                            </p>                      
                          </div>
                        </div>                                              
                        <div class="question">
                            <select id = "question_list" onChange = "questionDefaultCheck(this.value); explanationChange(this.value);">
                                <option value="none">ìì†Œì„œ ë¬¸í•­ì„ ì„ íƒí•˜ì„¸ìš”.</option>
                                {% for question in question_type %}
                                    <option value = {{ question.question_type_id }}>{{ question.question_type }}</option>
                                {% endfor %}
                                <option value="other">ì§ì ‘ì…ë ¥</option>
                            </select>
                            <div id="question-insert"></div>
                        </div>
                        <div class="question-contents">
                            <textarea name="" id="answers" placeholder="ìì†Œì„œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.&#13;&#10; &#13;&#10;ë‹µë³€ì´ ì—†ì–´ë„ ì¶”ì²œì€ í•´ë“œë¦¬ì§€ë§Œ, ì¶©ë¶„í•œ ë‹µë³€ì„ ì…ë ¥í•˜ë©´ ë‚˜ì—ê²Œ ë” ë§ëŠ” ì¶”ì²œì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”.&#13;&#10; &#13;&#10;ë§Œì•½ ë‹¹ì¥ ê¸€ì„ ì“°ê¸° ì–´ë µë‹¤ë©´, ìš°ì¸¡í•˜ë‹¨ 'ğŸ’«ìƒ˜í”Œ ìì†Œì„œ ë¶ˆëŸ¬ì˜¤ê¸°' ë²„íŠ¼ì„ í´ë¦­í•´ë³´ì„¸ìš”!&#13;&#10;ë¯¸ì™„ì„± ìƒ˜í”Œ ìì†Œì„œë¥¼ ë¶ˆëŸ¬ì™€ ë“œë¦½ë‹ˆë‹¤.&#13;&#10;&#13;&#10;â—â—â— ì‚¬ìš©ìì˜ ìê¸°ì†Œê°œì„œ ë‹µë³€ì€ ì ˆëŒ€ ì„œë²„ì— ê¸°ë¡ë˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.â—â—â—
                            " cols="30"
                                class="contents"></textarea>
                        </div>
                        <button type="submit" id="sample-button" onClick="questionTypeCheck();">ğŸ’«ìƒ˜í”Œ ìì†Œì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                        <button type="submit" id="recommend-button" class="btn" onClick="recbuttonClick('{% url 'logs:recbuttonlog' %}', '{% url 'services:answer_recommend' %}');">ì¶”ì²œë°›ê¸°</button>  
                    </div>
                    <div class="listWrap part" id="no-data">
                        <div id="waitMessage" class="listWrap part no-data">
                            <p>
                                <b>ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ğŸ¥º</b><br>
                                ë‹¤ë¥¸ ì¡°ê±´ìœ¼ë¡œ ì…ë ¥í•˜ì‹œê±°ë‚˜, ì¶”ì²œë°›ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                            </p>
                        </div>
                    </div>
                    <div class="listWrap part" id="exist-data">
                    </div>
                </div>
            </section>
        </div>
    </div>
</body>
</html>
<script type="text/javascript">
    var count = 0
    var totalData = ""
    var totalKeys = ""
    var isShown = [[true, false, false], [true, false, false], [true, false, false], [true, false, false]]
    var nowPages = [0, 0, 0, 0]
    var nowLogId = ""
    var nowCompany = ""
    var nowJobSmall = ""
    var nowQuestionType = ""
    var nowQuestionText = ""
    var nowContent = ""

    function explanationChange(value){
        const sampleBtn = document.getElementById('answers');
        if (value == "other") {
            sampleBtn.setAttribute('placeholder', 'ìì†Œì„œ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.\n10ì ì´ìƒ ì…ë ¥í•˜ì‹œë©´ ë‚˜ì—ê²Œ ë” ë§ëŠ” ì¶”ì²œì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”.')
        }
    }
    

    async function questionTypeCheck(){
        count = count+1
        const question_type = document.getElementById('question_list').value;
        if (question_type == 'none'){
            alert("ì§ˆë¬¸ ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì•¼ ìƒ˜í”Œì„ ì¶”ì²œë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
        }
        else{
            var samples = {{sample_list|safe}};
            document.getElementById("answers").value = ""
            var now_sample = await JSON.parse(samples[question_type][count%10])
            document.getElementById("answers").value = now_sample['content']
        }
    }


    async function recbuttonClick(logUrl, getAnswerUrl){
        nowLogId = await getUserLogging(logUrl)
        getRecommendData(getAnswerUrl, nowLogId)
        isShown = [[true, false, false, false], [true, false, false, false], [true, false, false, false], [true, false, false, false]]  // ìƒˆë¡œ ì¶”ì²œë²„íŠ¼ì„ ëˆŒë €ìœ¼ë©´ íƒœê·¸ í´ë¦­ ê¸°ë¡ê³¼ í˜„ì¬ í˜ì´ì§€ë¥¼ ì´ˆê¸°í™” í•˜ê¸°
        nowPages = [0, 0, 0, 0]
    }
    
    async function getUserLogging(url){
        /*
        var nowLogId = ""
        var nowCompany = ""
        var nowJobSmall = ""
        var nowQuestionType = ""
        var nowQuestionText = ""
        var nowContent = ""
        */

        nowCompany = document.getElementById('company-input').value
        if(nowCompany==""){
            alert("ê´€ì‹¬ê¸°ì—…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.")
            return -1
        }
        
        const query = 'input[name="job_detail"]:checked';
        nowJobSmall=document.querySelectorAll(query)[0];
        if (nowJobSmall){
            nowJobSmall = document.querySelectorAll(query)[0].id
        }
        else{
            alert("ì§ë¬´ ìƒì„¸ê²€ìƒ‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.")
            return -1
        }

        if(document.getElementById("question-input")){ 
            nowQuestionText = document.getElementById('question-text').value;
            nowQuestionType = 1000023;
        }else{
            nowQuestionType = document.getElementById('question_list').value;
            if (nowQuestionType == 'none'){
                alert("ì§ˆë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”")
                return -1
            }
        }
        
        const logData = {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{csrf_token}}",
            },
            body: JSON.stringify({
                userId: '{{ request.user }}',  // url íƒœê·¸ì™€ ê°™ì€ ê¸°ëŠ¥íƒœê·¸ëŠ” scriptíƒœê·¸ì—ì„œ í•´ì„ë˜ì§€ ì•Šì§€ë§Œ {{ variable }}ê³¼ ê°™ì€ ë³€ìˆ˜ íƒœê·¸ëŠ” í•´ì„ë¨
                company: nowCompany,
                jobType: nowJobSmall,
                questionType: nowQuestionType,
                questionContent: nowQuestionText
            }),
        }
        response = await fetch(url, logData)
        const data = await response.json()
        const logId = JSON.parse(data)['logId']
        return logId
    }

    async function getRecommendData(url, logId){
                /*
        var nowLogId = ""
        var nowCompany = ""
        var nowJobSmall = ""
        var nowQuestionType = ""
        var nowQuestionText = ""
        var nowContent = ""
        */


        // ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” í™”ë©´ render

        const render_window = document.querySelector(".listWrap>p")
        render_window.innerHTML = "<b>ìê¸°ì†Œê°œì„œë¥¼ ê°€ì ¸ì˜¤ê³  ìˆì–´ìš” ğŸ™ğŸ»</b><br>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>"
        render_window.setAttribute('class', 'exist-data')


        nowContent = document.getElementById("answers").value;
        const recommend_data = {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{csrf_token}}",
            },
            body: JSON.stringify({  
                company: nowCompany,
                jobType: nowJobSmall,
                questionType: nowQuestionType,
                questionText:nowQuestionText,
                content:nowContent,
                logId: nowLogId
            }),
        }

        const response = await fetch(url, recommend_data)

        const data = await response.json()
        const no_data = document.getElementById("no-data");
        no_data.classList.add("hide");
        const exist_data = document.getElementById("exist-data");
        exist_data.classList.add("show");

        render_window.setAttribute('class', 'no-data')
        if (data==412){
            alert("ì§ˆë¬¸ì„ ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        }
        else{
            makingRecommendList(data);
        }
    }

    
    function makingRecommendList(data) {
        totalData = data["recommendation"]
        totalKeys = Object.keys(totalData)
        tagLen = totalKeys.length
        const a = document.querySelector('#exist-data')
        var tag_name = 7000000
        a.replaceChildren()
        
        // dataì˜ key ìˆœíšŒ
        for (let i = 0; i <tagLen; i++){
            var key = totalKeys[i]
            var tag = totalData[key]
            var listLen = tag.length
            tag_name += 1
            var b = document.createElement('div')
            b.setAttribute('class', `list-column t${tag_name.toString()}`)
            var c1 = document.createElement('h3')
            c1.setAttribute('class', 'category')
            c1.setAttribute('style', 'display:inline-block;')

            if (i === 0) {
                c1.innerText = '# AIê°€ ' + '{{ request.user.username }}' + key
            } else {
                c1.innerText = '#' + key
            }
            

            var pageDiv = document.createElement('div')
            pageDiv.setAttribute('id', `tagIndex${i}`)
            pageDiv.setAttribute('style', 'position:flex')
            var nextPageImg = document.createElement('img')
            nextPageImg.setAttribute('class', 'changePage')
            var previousPageImg = document.createElement('img')
            previousPageImg.setAttribute('class', 'changePage')
            var nextPageA = document.createElement('a')
            var previousPageA = document.createElement('a')
            nextPageA.setAttribute('onClick', `nextPage(${i}, '{% url "services:page_change" %}')`)
            nextPageA.setAttribute('style', 'display:inline; cursor: pointer;')
            nextPageImg.setAttribute('id', `nextPage${i}`)
            nextPageImg.setAttribute('src', '/static/images/next.png')
            nextPageA.append(nextPageImg)
            previousPageA.setAttribute('onClick', `previousPage(${i}, '{% url "services:page_change" %}')`)
            previousPageA.setAttribute('style', 'display:inline; cursor: pointer;')
            previousPageImg.setAttribute('id', `previousPage${i}`)
            previousPageImg.setAttribute('src', '/static/images/noprevious.png')
            previousPageA.append(previousPageImg)
            pageDiv.append(c1, previousPageA, nextPageA)


            var c2 = document.createElement('div')
            c2.setAttribute('class', 'list')
            c2.setAttribute('id', `tag${i}Div`)

            for (let j = 0; j<4; j++) {
                // ê° keyì˜ answerë“¤ ìˆœíšŒ
                createTagElements(tag, tag_name, c2, j, key)
            }
            b.append(pageDiv, c2)
            a.append(b)
        }
    }

    function createTagElements(tag, tag_name, tagDiv, j, key) {
        var answer = tag[j]
        var content_id = answer.answer_id+tag_name.toString()
        var d1 = document.createElement('div')
        const season = answer.spec.slice(1,-1).split(',')[0]
        d1.setAttribute('class', 'item')
        d1.setAttribute('onClick', `popup_open(${content_id}); getAnswerLog(${ content_id }, '{% url "logs:answerlog" %}'); checkStatus('{{ request.user.username }}', ${content_id}, 't'+${tag_name.toString()}, '{% url "services:check_status" %}')`)
        var d_title = document.createElement('h4')
        d_title.setAttribute('class', 'title')
        d_title.innerText = answer.question
        var d_company = document.createElement('h4')
        d_company.setAttribute('class', 'company')
        d_company.innerText = answer.company + ' Â· ' + answer.job_small + ' Â· ' + season
        var d_content = document.createElement('p')
        d_content.setAttribute('class', 'contents')
        d_content.innerText = answer.summary
        var d2 = document.createElement('div')
        d2.setAttribute('class', 'popup')
        d2.setAttribute('id', `${content_id}`)
        var e = document.createElement('div')
        e.setAttribute('class', 'contents')
        var f1 = document.createElement('h3')
        f1.setAttribute('class', 'category')
        f1.setAttribute('name', tag_name)
        if (i === 0) {
            f1.innerText = '#' + '{{ request.user.username }}' + key
        } else {
            f1.innerText = '#' + key
        }
        var f2 = document.createElement('div')
        f2.setAttribute('class', 'info')
        var f3 = document.createElement('div')
        f3.setAttribute('class', 'text')
        var g1 = document.createElement('span')
        var f4 = document.createElement('a')
        f4.setAttribute('href', answer.document_url)
        f4.setAttribute('target', '_blank')
        f4.innerHTML="ğŸ”— ì´ ì§€ì›ìì˜ ë‹¤ë¥¸ ë¬¸í•­ ë”ë³´ê¸°"
        var f5 = document.createElement('button')
        f5.setAttribute('type', 'button')
        f5.setAttribute('class', 'btn btn_close')
        f5.setAttribute('onClick', `popup_close(${content_id})`)
        f5.innerText = 'X'
        var f6 = document.createElement('button')
        f6.setAttribute('type', 'button')
        f6.setAttribute('class', 'btn btn_good')
        f6.setAttribute('id', 'btn_good'+answer.answer_id)
        f6.setAttribute('value',answer.user_good_cnt)
        f6.setAttribute('onClick',`getUserGood(${content_id},${answer.user_good_cnt},'t'+${tag_name.toString()},'{% url "logs:evallog" %}')`)
        f6.innerText = 'ğŸ‘ '+answer.user_good_cnt
        var f7 = document.createElement('button')
        f7.setAttribute('type', 'button')
        f7.setAttribute('class', 'btn btn_bad')
        f7.setAttribute('id', 'btn_bad'+answer.answer_id)
        f7.setAttribute('value',answer.user_bad_cnt)
        f7.setAttribute('onClick',`getUserBad(${content_id},${answer.user_bad_cnt}, 't'+${tag_name.toString()},'{% url "logs:evallog" %}')`)
        f7.innerText = 'ğŸ‘ '+answer.user_bad_cnt
        g1.setAttribute('id', 'info-company')
        g1.setAttribute('style', 'display:inline; margin-bottom:2px;')
        g1.innerText = answer.company
        var markDiv = document.createElement('div')
        markDiv.setAttribute('id', 'bookmark'+content_id.slice(0,7))
        markDiv.setAttribute('style', 'position:flex')
        var markImg = document.createElement('img')
        var markA = document.createElement('a')
        markA.setAttribute('id', 'markA'+content_id.slice(0,7))
        markA.setAttribute('onClick', `fillMark(${content_id}, 't'+${tag_name.toString()}, '{% url "logs:userscrap" %}')`)
        markA.setAttribute('style', 'display:inline; cursor: pointer;')
        markImg.setAttribute('id', 'markImg'+content_id.slice(0,7))
        markImg.setAttribute('class', 'mark-empty')
        markImg.setAttribute('src', '/static/images/mark-empty.png')
        var g2 = document.createElement('span')
        g2.setAttribute('id', 'info-work')
        g2.innerText = answer.job_small
        var g3 = document.createElement('div')
        g3.setAttribute('class','info-spec')
        var g4 = document.createElement('h4')
        g4.setAttribute('class', 'title')
        g4.innerText = answer.question
        var g5 = document.createElement('p')
        g5.setAttribute('class', 'letter')
        g5.innerText = answer.content
        var h0 = document.createElement('span')
        h0.setAttribute('id', 'info-spec--school')
        h0.innerText = season
        var h1 = document.createElement('span')
        h1.setAttribute('id', 'info-spec--school')
        h1.innerText = answer.schooltype
        var h2 = document.createElement('span')
        h2.setAttribute('id', 'info-spec--major')
        h2.innerText = answer.major_small
        var h3 = document.createElement('span')
        h3.setAttribute('id', 'info-spec--extra_spec')
        var spec_array = answer.spec.slice(1,-1).split(',')
        for (let k = 1; k<spec_array.length; k++){
            var content = document.createElement('p')
            content.setAttribute('class', 'detail')
            content.innerText = spec_array[k].replace(/'/g, '')
            h3.append(content)
        }
        var helpDiv = document.createElement('div')
        helpDiv.setAttribute('class', 'help-tip')
        helpDiv.setAttribute('id', 'help-answer')
        var helpP = document.createElement('p')
        helpP.innerText = "<ë¶ë§ˆí¬ ì•„ì´ì½˜>\n ìì†Œì„œ ë‹µë³€ì´ ë§˜ì— ë“ ë‹¤ë©´, ë¶ë§ˆí¬ë¥¼ í´ë¦­í•´ë³´ì„¸ìš”.\n ë§ˆì´í˜ì´ì§€ì—ì„œ ë¶ë§ˆí¬í•œ ìì†Œì„œë“¤ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n <ì¢‹ì•„ìš” / ë³„ë¡œì—ìš”>\n ì´ ë‹µë³€ì´ ê´œì°®ì•˜ë‹¤ë©´ ğŸ‘ğŸ»ë¥¼, ë³„ë¡œì˜€ë‹¤ë©´ ğŸ‘ğŸ»ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”."
        helpDiv.append(helpP)

        g3.append(h0,h1, h2, h3)
        markA.append(markImg)
        markDiv.append(g1, markA, helpDiv)
        f3.append(g4, g5)
        f2.append(markDiv, g2, g3)
        e.append(f1, f2, f3, f4, f5, f6, f7)
        d2.append(e)
        d1.append(d_company, d_title, d_content)
        tagDiv.append(d1, d2)
    }
    
    
    function changeTagElements(tag, tagName, tagIndex, page, key){
        var tagDiv = document.querySelector(`#tag${tagIndex}Div`)
        tagDiv.replaceChildren()
        for (let j=0; j<4; j++) {
            createTagElements(tag, tagName, tagDiv, j, key)
        }
    }


    async function nextPage(tagIndex, url) {
        // var isShown = [[true, false, false, false], [true, false, false, false], [true, false, false, false], [true, false, false, false]]
        // var nowPages = [0, 0, 0, 0]
        if (nowPages[tagIndex]==2) {
            return -1
        } else if (nowPages[tagIndex]==1) {
            const nextBtn = document.querySelector(`#nextPage${tagIndex}`)
            nextBtn.setAttribute('src', '/static/images/nonext.png')
        } else if (nowPages[tagIndex]==0) {
            const previousBtn = document.querySelector(`#previousPage${tagIndex}`)
            previousBtn.setAttribute('src', '/static/images/previous.png')
        }

        nowPages[tagIndex]++
        var page = nowPages[tagIndex]
        var tagName = 7000001 + tagIndex


        var isSeen = isShown[tagIndex][page]
        var key = totalKeys[tagIndex]
        var pageData = totalData[key]
        var answers = pageData.slice(4*page, 4*(page+1))
        var answerIds = answers.map(function(value){
            return value.answer_id
        })
        
        changeTagElements(answers, tagName, tagIndex, page, key)
        // ë§Œì¼ ì´ë¯¸ ë³¸ í˜ì´ì§€ë©´ ë³´ê³ í•  í•„ìš”ê°€ ì—†ìŒ
        if (isSeen) {
            return -1
        }

        const changeData = {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{csrf_token}}",
            },
            body: JSON.stringify({
                tagIdx : tagIndex,
                answerIds: answerIds,
                logId: nowLogId, 
            }),
        }

        const response = await fetch(url, changeData)
        
        isShown[tagIndex][page] = true
    }
    // í˜„ì¬ íƒœê·¸ì™€ ë°±ì—”ë“œ urlì„ ë°›ìŒ  => accounts:page_change




    // now pages[í˜„ì¬ íƒœê·¸]ë¥¼ 1 ì˜¬ë ¤ì£¼ê³  isShown[í˜„ì¬ íƒœê·¸][now pages]ë¥¼ trueë¡œ ë°”ê¿”ì¤Œ

    async function previousPage(tagIndex, url) {
        // ìƒê°í•´ë³´ë‹ˆ ì´ì „í˜ì´ì§€ë¡œ ê°ˆ ë•ŒëŠ” ë¡œê·¸ë¥¼ ìŒ“ì„ í•„ìš”ê°€ ì—†ìŒ
        if (nowPages[tagIndex]==0) {
            return -1
        } else if (nowPages[tagIndex]==1) {
            const previousBtn = document.querySelector(`#previousPage${tagIndex}`)
            previousBtn.setAttribute('src', '/static/images/noprevious.png')
        } else if (nowPages[tagIndex]==2) {
            const nextBtn = document.querySelector(`#nextPage${tagIndex}`)
            nextBtn.setAttribute('src', '/static/images/next.png')
        }


        nowPages[tagIndex]--
        var page = nowPages[tagIndex]
        var tagName = 7000001 + tagIndex
        var key = totalKeys[tagIndex]
        var pageData = totalData[key]

        var answers = pageData.slice(4*page, 4*(page+1))
        changeTagElements(answers, tagName, tagIndex, page, key)
    }

    // í˜„ì¬ íƒœê·¸ì™€ ë°±ì—”ë“œ urlì„ ë°›ìŒ
    


    // now pages[í˜„ì¬ íƒœê·¸]ë¥¼ 1 ë‚´ë ¤ì£¼ê³  isShown





    
    async function checkStatus(username, contentId, tagId, url) {
        const answerId = contentId.id.slice(0, 7)
        const markImg = document.querySelector('.'+tagId+' #markImg'+answerId);
        const goodBtn = document.querySelector("."+tagId+" #btn_good"+answerId)
        const badBtn = document.querySelector("."+tagId+" #btn_bad"+answerId)

        const markData = {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{csrf_token}}",
            },
            body: JSON.stringify({ 
                user_id: username,
                answer_id: answerId
            })
        }
        const response = await fetch(url, markData)
        const dataString = await response.json()
        const data = JSON.parse(dataString)

        const goodCnt = data["goodCnt"]
        const badCnt = data["badCnt"]
        const isBoth = data["both"]
        const isScrap = data["isScrap"]
        const isEval = data["isEval"]
        

        // ì¹´ìš´íŠ¸ ì„¤ì •
        goodBtn.setAttribute('value', goodCnt)
        goodBtn.innerHTML = 'ğŸ‘ğŸ» ' + goodCnt.toString()
        badBtn.setAttribute('value', badCnt)
        badBtn.innerHTML = 'ğŸ‘ğŸ» ' + badCnt.toString()
       
        // ìŠ¤í¬ë© ë²„íŠ¼ ì´ˆê¸°í™”
        if (isScrap) {
            markImg.setAttribute('class', 'mark-fill')
            markImg.setAttribute('src', '/static/images/mark-fill.png')
        } else {
            markImg.setAttribute('class', 'mark-empty')
            markImg.setAttribute('src', '/static/images/mark-empty.png')            
        }
    }


    function getAnswerLog(answer_id, url){
        const user_id = '{{ request.user }}';
        const content_id = answer_id.id;
        const rec_type =document.querySelector('#'+content_id+' .category').getAttribute('name');
        const answer_data = {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{csrf_token}}",
            },
            body: JSON.stringify({  
                userId: user_id,  
                contentId: content_id.slice(0,7),
                recType: rec_type,
            }),
        }
        fetch(url, answer_data)
        .then((res) => res.json())
        .catch((error)=> console.log('error ë°œìƒ'));
    }
    
    async function getUserGood(contents_id,cnt,tagId,url){
        const user_id = '{{ request.user }}';
        const content_id = contents_id.id.slice(0,7)
        var btn_good = document.querySelector("."+tagId+" #btn_good"+content_id)
        var btn_bad = document.querySelector("."+tagId+" #btn_bad"+content_id)
        const good = Number(btn_good.getAttribute('value')) + 1
        var bad = Number(btn_bad.getAttribute('value'))
        const user_good = {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{csrf_token}}",
            },
            body: JSON.stringify({
                userId: user_id, 
                contentId: content_id,
                goodCnt: good,
                badCnt:bad,
                favor:1,
            }),
        }
        const response = await fetch(url, user_good)
        const data = await response.json()
        if (data==201){
            btn_good.innerHTML = 'ğŸ‘ğŸ» '+good
            btn_good.value = good
        }
        else if(data==301){
            bad = bad-1
            btn_bad.innerHTML = 'ğŸ‘ğŸ» '+bad
            btn_bad.value = bad
            btn_good.innerHTML = 'ğŸ‘ğŸ» '+good
            btn_good.value = good
        }
        else{
            alert("ì´ë¯¸ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ìì†Œì„œì…ë‹ˆë‹¤.")
        }
    }

    async function getUserBad(contents_id,cnt,tagId,url){
        const user_id = '{{ request.user }}';
        const content_id = contents_id.id.slice(0,7)
        var btn_good = document.querySelector("."+tagId+" #btn_good"+content_id)
        var btn_bad = document.querySelector("."+tagId+" #btn_bad"+content_id)
        var good = Number(btn_good.getAttribute('value'))
        const bad = Number(btn_bad.getAttribute('value')) + 1
        const user_bad = {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{csrf_token}}",
            },
            body: JSON.stringify({ 
                userId: user_id, 
                contentId: content_id,
                goodCnt: good,
                badCnt:bad,
                favor:0,
            }),
        }
        const response = await fetch(url, user_bad)
        const data = await response.json()
        if (data==201){
            btn_bad.innerHTML = 'ğŸ‘ğŸ» '+bad
            btn_bad.value = bad
        }
        else if(data==301){
            good = good-1
            btn_bad.innerHTML = 'ğŸ‘ğŸ» '+bad
            btn_bad.value = bad
            btn_good.innerHTML = 'ğŸ‘ğŸ» '+good
            btn_good.value = good
        }
        else{
            alert("ì´ë¯¸ ë³„ë¡œì—ìš”ë¥¼ ëˆ„ë¥¸ ìì†Œì„œì…ë‹ˆë‹¤.")
        }
    }   


    async function fillMark(answerTag, tagId, url) {
        const answerId = answerTag.id.slice(0, 7)
        const markImg = document.querySelector('.'+tagId+' #markImg'+answerId);
        const userId = '{{ request.user }}';
        
        const markData = {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{csrf_token}}",
            },
            body: JSON.stringify({ 
                user_id: userId,
                answer_id: answerId
            })
        }
        const response = await fetch(url, markData)
        if (response.status === 201) {
            markImg.setAttribute('class', 'mark-fill')
            markImg.setAttribute('src', '/static/images/mark-fill.png')
        } else if (response.status === 200) {
            markImg.setAttribute('class', 'mark-empty')
            markImg.setAttribute('src', '/static/images/mark-empty.png')
        }
    }


</script> 
{% endblock %}
